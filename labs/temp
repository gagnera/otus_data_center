hostname LF0
!
spanning-tree mode mstp
!
vlan 100,200
!
vrf instance EVPNL3
!
interface Ethernet1
   description SP0
   no switchport
   ip address 10.0.0.2/30
!
interface Ethernet2
   description SP1
   no switchport
   ip address 10.0.1.2/30
!
interface Ethernet3
!
interface Ethernet4
!
interface Ethernet5
!
interface Ethernet6
!
interface Ethernet7
   description CL00
   switchport access vlan 100
!
interface Ethernet8
   description CL01
   switchport access vlan 200
!
interface Loopback0
   ip address 10.0.254.0/32
!
interface Management1
!
interface Vlan100
   description BLUE_VLAN
   vrf EVPNL3
   ip address virtual 172.22.1.1/24
!
interface Vlan200
   description RED_VLAN
   vrf EVPNL3
   ip address virtual 172.22.2.1/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 100 vni 100
   vxlan vlan 200 vni 200
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
router bgp 65000
   router-id 10.0.254.0
   timers bgp 1 3
   maximum-paths 2 ecmp 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.1 remote-as 65000
   neighbor 10.0.0.1 bfd
   neighbor 10.0.1.1 remote-as 65000
   neighbor 10.0.1.1 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 100
      rd 65000:100
      route-target import 65000:100
      route-target export 65000:100
      redistribute learned
   !
   vlan 200
      rd 65000:200
      route-target import 65000:200
      route-target export 65000:200
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.254.0/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      redistribute connected
!
end

----

hostname LF1
!
spanning-tree mode mstp
!
vlan 100
!
vrf instance EVPNL3
!
interface Ethernet1
!
interface Ethernet2
   description SP0
   no switchport
   ip address 10.0.0.6/30
!
interface Ethernet3
   description SP1
   no switchport
   ip address 10.0.1.6/30
!
interface Ethernet4
!
interface Ethernet5
!
interface Ethernet6
!
interface Ethernet7
!
interface Ethernet8
   description CL10
   switchport access vlan 100
!
interface Loopback0
   ip address 10.0.254.1/32
!
interface Management1
!
interface Vlan100
   description BLUE_VLAN
   vrf EVPNL3
   ip address virtual 172.22.1.1/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 100 vni 100
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
router bgp 65000
   router-id 10.0.254.1
   timers bgp 1 3
   maximum-paths 2 ecmp 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.5 remote-as 65000
   neighbor 10.0.0.5 bfd
   neighbor 10.0.1.5 remote-as 65000
   neighbor 10.0.1.5 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 100
      rd 65000:100
      route-target import 65000:100
      route-target export 65000:100
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.254.1/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      redistribute connected
!
end
------
hostname LF2
!
spanning-tree mode mstp
no spanning-tree vlan-id 4094
!
vlan 200
!
vlan 4094
   trunk group m1peer
!
vrf instance EVPNL3
!
interface Port-Channel10
   switchport mode trunk
   switchport trunk group m1peer
!
interface Port-Channel20
   description CL20
   switchport access vlan 200
   switchport trunk allowed vlan 200
   switchport mode trunk
   mlag 20
!
interface Ethernet1
!
interface Ethernet2
!
interface Ethernet3
   description SP0
   no switchport
   ip address 10.0.0.10/30
!
interface Ethernet4
   description SP1
   no switchport
   ip address 10.0.1.10/30
!
interface Ethernet5
!
interface Ethernet6
   channel-group 10 mode active
!
interface Ethernet7
   channel-group 10 mode active
!
interface Ethernet8
   description CL20
   channel-group 20 mode active
!
interface Loopback0
   ip address 10.0.254.2/32
!
interface Management1
!
interface Vlan200
   description RED_VLAN
   vrf EVPNL3
   ip address virtual 172.22.2.1/24
!
interface Vlan4094
   no autostate
   ip address 192.168.0.1/30
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 200 vni 200
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
mlag configuration
   domain-id mlag
   heartbeat-interval 2500
   local-interface Vlan4094
   peer-address 192.168.0.2
   peer-link Port-Channel10
!
router bgp 65000
   router-id 10.0.254.2
   timers bgp 1 3
   maximum-paths 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.9 remote-as 65000
   neighbor 10.0.0.9 bfd
   neighbor 10.0.1.9 remote-as 65000
   neighbor 10.0.1.9 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 200
      rd 65000:200
      route-target import 65000:200
      route-target export 65000:200
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.253.2/32
      network 10.0.254.2/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      redistribute connected
!
end
--------
hostname LF3
!
spanning-tree mode mstp
no spanning-tree vlan-id 4094
!
vlan 200
!
vlan 4094
   trunk group m1peer
!
vrf instance EVPNL3
!
interface Port-Channel10
   switchport mode trunk
   switchport trunk group m1peer
!
interface Port-Channel20
   description CL20
   switchport access vlan 200
   switchport trunk allowed vlan 200
   switchport mode trunk
   mlag 20
!
interface Ethernet1
!
interface Ethernet2
!
interface Ethernet3
!
interface Ethernet4
   description SP0
   no switchport
   ip address 10.0.0.14/30
!
interface Ethernet5
   description SP1
   no switchport
   ip address 10.0.1.14/30
!
interface Ethernet6
   channel-group 10 mode active
!
interface Ethernet7
   channel-group 10 mode active
!
interface Ethernet8
   description CL20
   channel-group 20 mode active
!
interface Loopback0
   ip address 10.0.254.3/32
!
interface Management1
!
interface Vlan200
   description RED_VLAN
   vrf EVPNL3
   ip address virtual 172.22.2.1/24
!
interface Vlan4094
   no autostate
   ip address 192.168.0.2/30
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 200 vni 200
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
mlag configuration
   domain-id mlag
   heartbeat-interval 2500
   local-interface Vlan4094
   peer-address 192.168.0.1
   peer-link Port-Channel10
!
router bgp 65000
   router-id 10.0.254.3
   timers bgp 1 3
   maximum-paths 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.13 remote-as 65000
   neighbor 10.0.0.13 bfd
   neighbor 10.0.1.13 remote-as 65000
   neighbor 10.0.1.13 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 200
      rd 65000:200
      route-target import 65000:200
      route-target export 65000:200
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.253.3/32
      network 10.0.254.3/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
      redistribute connected
!
end
----
LF3#sh mlag int det
                                        local/remote
 mlag         state   local   remote    oper    config    last change   changes
------ ------------- ------- -------- ------- --------- --------------- -------
   20   active-full    Po20     Po20   up/up   ena/ena   23:35:10 ago         4

LF2#sh mlag int det
                                        local/remote
 mlag         state   local   remote    oper    config    last change   changes
------ ------------- ------- -------- ------- --------- --------------- -------
   20   active-full    Po20     Po20   up/up   ena/ena   23:35:33 ago         4

LF3#sh bgp evpn
BGP routing table information for VRF default
Router identifier 10.0.254.3, local AS number 65000
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >Ec    RD: 65000:100 imet 10.0.254.0
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 imet 10.0.254.0
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:200 imet 10.0.254.0
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:200 imet 10.0.254.0
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:100 imet 10.0.254.1
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 imet 10.0.254.1
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.1
 * >Ec    RD: 65000:200 imet 10.0.254.2
                                 10.0.254.2            -       100     0       i Or-ID: 10.0.254.2 C-LST: 10.0.255.1
 *  ec    RD: 65000:200 imet 10.0.254.2
                                 10.0.254.2            -       100     0       i Or-ID: 10.0.254.2 C-LST: 10.0.255.0
 * >      RD: 65000:200 imet 10.0.254.3
                                 -                     -       -       0       i
 * >Ec    RD: 65000:1 ip-prefix 172.22.1.0/24
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:1 ip-prefix 172.22.1.0/24
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >      RD: 65000:1 ip-prefix 172.22.2.0/24
                                 -                     -       -       0       i
 *        RD: 65000:1 ip-prefix 172.22.2.0/24
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 *        RD: 65000:1 ip-prefix 172.22.2.0/24
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
LF3#
LF3#
----
LF3#sh vxlan address-table
          Vxlan Mac Address Table
----------------------------------------------------------------------

VLAN  Mac Address     Type      Prt  VTEP             Moves   Last Move
----  -----------     ----      ---  ----             -----   ---------
 200  5000.0045.abdf  EVPN      Vx1  10.0.254.0       1       0:00:26 ago
4093  5000.0003.3766  EVPN      Vx1  10.0.254.1       1       0:00:03 ago
4093  5000.00d5.5dc0  EVPN      Vx1  10.0.254.0       1       0:16:15 ago
Total Remote Mac Addresses for this criterion: 3


CL20#ping 172.22.1.100
PING 172.22.1.100 (172.22.1.100) 72(100) bytes of data.
80 bytes from 172.22.1.100: icmp_seq=1 ttl=62 time=91.8 ms
80 bytes from 172.22.1.100: icmp_seq=2 ttl=62 time=87.4 ms
80 bytes from 172.22.1.100: icmp_seq=3 ttl=62 time=79.2 ms
80 bytes from 172.22.1.100: icmp_seq=4 ttl=62 time=70.9 ms
80 bytes from 172.22.1.100: icmp_seq=5 ttl=62 time=62.3 ms

--- 172.22.1.100 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 48ms
rtt min/avg/max/mdev = 62.393/78.361/91.817/10.718 ms, pipe 5, ipg/ewma 12.136/84.283 ms
CL20#
CL20#ping 172.22.2.200
PING 172.22.2.200 (172.22.2.200) 72(100) bytes of data.
80 bytes from 172.22.2.200: icmp_seq=1 ttl=64 time=70.0 ms
80 bytes from 172.22.2.200: icmp_seq=2 ttl=64 time=66.0 ms
80 bytes from 172.22.2.200: icmp_seq=3 ttl=64 time=56.2 ms
80 bytes from 172.22.2.200: icmp_seq=4 ttl=64 time=48.9 ms
80 bytes from 172.22.2.200: icmp_seq=5 ttl=64 time=39.8 ms

--- 172.22.2.200 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 54ms
rtt min/avg/max/mdev = 39.838/56.221/70.046/11.027 ms, pipe 5, ipg/ewma 13.541/62.306 ms
CL20#
CL20#ping 172.22.1.110
PING 172.22.1.110 (172.22.1.110) 72(100) bytes of data.
80 bytes from 172.22.1.110: icmp_seq=1 ttl=62 time=137 ms
80 bytes from 172.22.1.110: icmp_seq=2 ttl=62 time=139 ms
80 bytes from 172.22.1.110: icmp_seq=3 ttl=62 time=133 ms
80 bytes from 172.22.1.110: icmp_seq=4 ttl=62 time=124 ms
80 bytes from 172.22.1.110: icmp_seq=5 ttl=62 time=114 ms

--- 172.22.1.110 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 54ms
rtt min/avg/max/mdev = 114.986/130.208/139.790/9.135 ms, pipe 5, ipg/ewma 13.694/133.145 ms
CL20#
CL20#
