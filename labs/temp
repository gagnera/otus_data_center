
hostname LF0
!
spanning-tree mode mstp
!
vlan 100,200
!
vrf instance EVPNL3
!
interface Ethernet1
   description SP0
   no switchport
   ip address 10.0.0.2/30
!
interface Ethernet2
   description SP1
   no switchport
   ip address 10.0.1.2/30
!
interface Ethernet3
!
interface Ethernet4
!
interface Ethernet5
!
interface Ethernet6
!
interface Ethernet7
   description CL00
   switchport access vlan 100
!
interface Ethernet8
   description CL01
   switchport access vlan 200
!
interface Loopback0
   ip address 10.0.254.0/32
!
interface Management1
!
interface Vlan100
   description BLUE_VLAN
   vrf EVPNL3
   ip address virtual 172.22.1.1/24
!
interface Vlan200
   description RED_VLAN
   vrf EVPNL3
   ip address virtual 172.22.2.1/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 100 vni 100
   vxlan vlan 200 vni 200
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
router bgp 65000
   router-id 10.0.254.0
   timers bgp 1 3
   maximum-paths 2 ecmp 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.1 remote-as 65000
   neighbor 10.0.0.1 bfd
   neighbor 10.0.1.1 remote-as 65000
   neighbor 10.0.1.1 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 100
      rd 65000:100
      route-target import 65000:100
      route-target export 65000:100
      redistribute learned
   !
   vlan 200
      rd 65000:200
      route-target import 65000:200
      route-target export 65000:200
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.254.0/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
!
!
hostname LF1
!
spanning-tree mode mstp
!
vlan 100
!
vrf instance EVPNL3
!
interface Ethernet1
!
interface Ethernet2
   description SP0
   no switchport
   ip address 10.0.0.6/30
!
interface Ethernet3
   description SP1
   no switchport
   ip address 10.0.1.6/30
!
interface Ethernet4
!
interface Ethernet5
!
interface Ethernet6
!
interface Ethernet7
!
interface Ethernet8
   description CL10
   switchport access vlan 100
!
interface Loopback0
   ip address 10.0.254.1/32
!
interface Management1
!
interface Vlan100
   description BLUE_VLAN
   vrf EVPNL3
   ip address virtual 172.22.1.1/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 100 vni 100
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
ip routing vrf EVPNL3
!
router bgp 65000
   router-id 10.0.254.1
   timers bgp 1 3
   maximum-paths 2 ecmp 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.5 remote-as 65000
   neighbor 10.0.0.5 bfd
   neighbor 10.0.1.5 remote-as 65000
   neighbor 10.0.1.5 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 100
      rd 65000:100
      route-target import 65000:100
      route-target export 65000:100
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.254.1/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
!
hostname LF2
!
spanning-tree mode mstp
!
vlan 200
!
vrf instance EV
!
vrf instance EVPNL3
!
interface Ethernet1
!
interface Ethernet2
!
interface Ethernet3
   description SP0
   no switchport
   ip address 10.0.0.10/30
!
interface Ethernet4
   description SP1
   no switchport
   ip address 10.0.1.10/30
!
interface Ethernet5
!
interface Ethernet6
!
interface Ethernet7
!
interface Ethernet8
   description CL20
   switchport access vlan 200
!
interface Loopback0
   ip address 10.0.254.2/32
!
interface Management1
!
interface Vlan200
   description RED_VLAN
   vrf EVPNL3
   ip address virtual 172.22.2.1/24
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   vxlan vlan 200 vni 200
   vxlan vrf EVPNL3 vni 1
   vxlan learn-restrict any
!
ip routing
no ip routing vrf EV
ip routing vrf EVPNL3
!
router bgp 65000
   router-id 10.0.254.2
   timers bgp 1 3
   maximum-paths 2
   neighbor EVPN peer group
   neighbor EVPN remote-as 65000
   neighbor EVPN update-source Loopback0
   neighbor EVPN send-community extended
   neighbor 10.0.0.9 remote-as 65000
   neighbor 10.0.0.9 bfd
   neighbor 10.0.1.9 remote-as 65000
   neighbor 10.0.1.9 bfd
   neighbor 10.0.255.0 peer group EVPN
   neighbor 10.0.255.1 peer group EVPN
   !
   vlan 200
      rd 65000:200
      route-target import 65000:200
      route-target export 65000:200
      redistribute learned
   !
   address-family evpn
      neighbor EVPN activate
   !
   address-family ipv4
      network 10.0.254.2/32
   !
   vrf EVPNL3
      rd 65000:1
      route-target import evpn 65000:1
      route-target export evpn 65000:1
!


LF2#sh ip rou vrf EVPNL3
 B I      172.22.1.100/32 [200/0] via VTEP 10.0.254.0 VNI 1 router-mac 50:00:00:d5:5d:c0 local-interface Vxlan1
 B I      172.22.1.110/32 [200/0] via VTEP 10.0.254.1 VNI 1 router-mac 50:00:00:03:37:66 local-interface Vxlan1
 B I      172.22.2.200/32 [200/0] via VTEP 10.0.254.0 VNI 1 router-mac 50:00:00:d5:5d:c0 local-interface Vxlan1
 C        172.22.2.0/24 is directly connected, Vlan200

LF2#sh bgp evpn route-type mac-ip
BGP routing table information for VRF default
Router identifier 10.0.254.2, local AS number 65000
Route status codes: * - valid, > - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending BGP convergence
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * >      RD: 65000:200 mac-ip 5000.002f.d8fe
                                 -                     -       -       0       i
 * >Ec    RD: 65000:200 mac-ip 5000.0045.abdf
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:200 mac-ip 5000.0045.abdf
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:200 mac-ip 5000.0045.abdf 172.22.2.200
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:200 mac-ip 5000.0045.abdf 172.22.2.200
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:100 mac-ip 5000.0088.fe27
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 mac-ip 5000.0088.fe27
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:100 mac-ip 5000.0088.fe27 172.22.1.100
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 mac-ip 5000.0088.fe27 172.22.1.100
                                 10.0.254.0            -       100     0       i Or-ID: 10.0.254.0 C-LST: 10.0.255.1
 * >Ec    RD: 65000:100 mac-ip 5000.00ae.f703
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 mac-ip 5000.00ae.f703
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.1
 * >Ec    RD: 65000:100 mac-ip 5000.00ae.f703 172.22.1.110
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.0
 *  ec    RD: 65000:100 mac-ip 5000.00ae.f703 172.22.1.110
                                 10.0.254.1            -       100     0       i Or-ID: 10.0.254.1 C-LST: 10.0.255.1
LF2#


CL20#ping 172.22.1.100
PING 172.22.1.100 (172.22.1.100) 72(100) bytes of data.
80 bytes from 172.22.1.100: icmp_seq=1 ttl=63 time=76.4 ms
80 bytes from 172.22.1.100: icmp_seq=2 ttl=63 time=96.0 ms
80 bytes from 172.22.1.100: icmp_seq=3 ttl=63 time=110 ms
80 bytes from 172.22.1.100: icmp_seq=4 ttl=63 time=103 ms
80 bytes from 172.22.1.100: icmp_seq=5 ttl=63 time=100 ms

--- 172.22.1.100 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 56ms
rtt min/avg/max/mdev = 76.410/97.573/110.869/11.637 ms, pipe 5, ipg/ewma 14.033/87.387 ms
CL20#
CL20#
CL20#
CL20#ping 172.22.1.110
PING 172.22.1.110 (172.22.1.110) 72(100) bytes of data.
80 bytes from 172.22.1.110: icmp_seq=1 ttl=63 time=106 ms
80 bytes from 172.22.1.110: icmp_seq=2 ttl=63 time=106 ms
80 bytes from 172.22.1.110: icmp_seq=3 ttl=63 time=100 ms
80 bytes from 172.22.1.110: icmp_seq=4 ttl=63 time=89.1 ms
80 bytes from 172.22.1.110: icmp_seq=5 ttl=63 time=84.4 ms

--- 172.22.1.110 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 48ms
rtt min/avg/max/mdev = 84.496/97.384/106.451/9.008 ms, pipe 5, ipg/ewma 12.179/101.162 ms
CL20#
CL20#ping 172.22.2.200
PING 172.22.2.200 (172.22.2.200) 72(100) bytes of data.
80 bytes from 172.22.2.200: icmp_seq=1 ttl=64 time=124 ms
80 bytes from 172.22.2.200: icmp_seq=2 ttl=64 time=148 ms
80 bytes from 172.22.2.200: icmp_seq=3 ttl=64 time=181 ms
80 bytes from 172.22.2.200: icmp_seq=4 ttl=64 time=179 ms
80 bytes from 172.22.2.200: icmp_seq=5 ttl=64 time=164 ms

--- 172.22.2.200 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 59ms
rtt min/avg/max/mdev = 124.139/159.695/181.602/21.312 ms, pipe 5, ipg/ewma 14.874/142.788 ms
CL20#
